<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dual Group Timer Control System (SYNCED STOPWATCH)</title>
    <style>
        :root {
            --color-primary: #208c91;
            --color-secondary: #f5f5f5;
            --color-text: #1f2121;
            --color-border: #5e5240;
            --color-red: #c0152f;
            --color-green: #228c3d;
            --color-blue: #2180ff;
            --color-yellow: #e68161;
            --color-pink: #ef4899;
            --spacing: 16px;
            --radius: 8px;
            --color-dark: #333;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--color-secondary);
            color: var(--color-text);
            padding: var(--spacing);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 8px;
            color: var(--color-primary);
        }

        .header p {
            font-size: 14px;
            color: #666;
        }

        .view-toggle {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .view-btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: 500;
            transition: all 250ms;
            background: white;
            border: 2px solid var(--color-border);
            color: var(--color-text);
        }

        .view-btn.active {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        .content {
            display: none;
        }

        .content.active {
            display: block;
        }
        
        /* Admin Login Styling */
        .login-section {
            max-width: 400px; 
            margin: 40px auto; 
            padding: 20px; 
            background: white; 
            border: 2px solid var(--color-primary); 
            border-radius: var(--radius);
            text-align: center;
        }
        
        .login-section h2 {
            color: var(--color-dark);
            margin-bottom: 15px;
        }

        .login-input-group {
            display: flex; 
            gap: 10px; 
            margin-top: 15px;
        }

        .login-input-group input {
            flex: 1; 
            padding: 10px; 
            border: 1px solid var(--color-border); 
            border-radius: 4px; 
            font-size: 14px;
        }

        .login-input-group button {
            padding: 10px 20px; 
            background: var(--color-primary); 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-weight: 600;
        }
        
        .login-message {
            margin-top: 15px;
            font-size: 14px;
        }
        /* --- */

        .waves-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        /* Main Admin Content Layout */
        #admin-view .content-wrapper {
            display: flex;
            gap: 30px;
        }
        
        #admin-view .timer-controls-area {
            flex: 2; 
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        
        #admin-view .leaderboard-area {
            flex: 1; 
            background: white;
            border: 2px solid var(--color-primary);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .wave-panel {
            background: white;
            border: 2px solid var(--color-border);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }

        .wave-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--color-border);
        }

        .wave-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-primary);
        }

        .wave-number-input {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .wave-number-input input {
            width: 80px;
            padding: 8px;
            border: 1px solid var(--color-border);
            border-radius: 4px;
            font-size: 14px;
            text-align: center;
        }

        .colors-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
            flex-grow: 1; 
        }

        .color-card {
            background: white;
            border: 2px solid #ddd;
            border-radius: var(--radius);
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .color-indicator {
            width: 100%;
            height: 40px;
            border-radius: 4px;
            border: 2px solid #ddd;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        /* Style for the color status selector */
        .color-status-select {
            width: 100%;
            padding: 4px;
            border: 1px solid var(--color-border);
            border-radius: 4px;
            font-size: 10px;
            text-align: center;
            background: white;
        }

        .color-name {
            font-size: 12px;
            font-weight: 600;
            text-align: center;
            color: var(--color-text);
            margin-bottom: 4px;
        }
        
        .color-card.na {
            opacity: 0.6;
            background: #eee;
        }

        .timer-display {
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            font-family: 'Courier New', monospace;
            color: var(--color-text);
            min-height: 24px;
            margin-top: 4px;
        }

        /* BIB Input Styling */
        .bib-input-group {
            display: flex;
            align-items: center;
            font-size: 10px;
            font-weight: 600;
            gap: 2px;
            justify-content: center;
            margin-bottom: 8px; 
            color: var(--color-dark);
        }
        
        .bib-input-group input {
            width: 35px;
            padding: 2px 1px;
            border: 1px solid var(--color-border);
            border-radius: 2px;
            text-align: center;
            font-size: 10px;
            line-height: 1;
        }
        /* --- */

        .wave-controls-container {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid var(--color-border);
            display: flex;
            gap: 10px;
            flex-wrap: wrap; 
        }
        
        .wave-controls-container button {
            padding: 12px 10px;
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            flex: 1 1 30%; 
            transition: all 250ms;
        }
        
        .wave-start-btn {
            background: var(--color-primary);
        }

        .wave-reset-btn {
            background: var(--color-red);
        }
        
        .wave-next-btn {
            background: var(--color-yellow);
        }
        
        .wave-next-btn:hover:not(:disabled) {
             background: #c06540;
        }
        
        .wave-start-btn:hover:not(:disabled) {
            background: #1a6b7a;
        }
        
        .wave-reset-btn:hover:not(:disabled) {
            background: #9a0f23;
        }

        .wave-start-btn:disabled, .wave-reset-btn:disabled, .wave-next-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .volunteer-dashboard {
            background: white;
            border: 3px solid var(--color-primary);
            border-radius: var(--radius);
            padding: 30px;
            text-align: center;
            max-width: 500px;
            margin: 0 auto;
        }

        .volunteer-header {
            margin-bottom: 30px;
        }

        .volunteer-wave-number {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .volunteer-color-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin: 20px 0;
        }

        .volunteer-color-box {
            width: 100px;
            height: 100px;
            border-radius: 8px;
            border: 3px solid var(--color-border);
        }

        .volunteer-color-name {
            font-size: 32px;
            font-weight: bold;
            color: var(--color-text);
        }

        .volunteer-timer {
            font-size: 48px;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            margin: 20px 0;
            padding: 20px;
            background: #f0f0f0;
            border-radius: var(--radius);
            min-height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .volunteer-timer.na-status {
            background: #ffdbdb;
            color: var(--color-red);
        }

        .volunteer-controls {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .btn-volunteer-stop {
            flex: 1;
            padding: 14px 20px;
            border: none;
            border-radius: var(--radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 250ms;
            background: var(--color-red);
            color: white;
        }

        .btn-volunteer-stop:hover:not(:disabled) {
            background: #9a0f23;
        }

        .btn-volunteer-stop:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .access-code-section {
            background: #f9f9f9;
            border: 2px solid var(--color-primary);
            border-radius: var(--radius);
            padding: 20px;
            margin-top: 20px;
            text-align: center;
            grid-column: span 5;
        }

        .access-code-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }

        .access-code-list {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .access-code {
            font-size: 16px;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            color: var(--color-text);
            padding: 5px 10px;
            background: white;
            border: 1px solid var(--color-border);
            border-radius: 4px;
        }
        
        /* Leaderboard Styling */
        .leaderboard-area {
            display: flex;
            flex-direction: column;
        }

        .leaderboard-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: 15px;
            text-align: center;
        }

        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .leaderboard-table th, .leaderboard-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        .leaderboard-table th {
            background-color: #f2f2f2;
            font-weight: 600;
        }
        
        .stopped-time {
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }
        
        .reset-all-btn {
            margin-top: 20px;
            padding: 12px;
            background: var(--color-dark);
            color: white;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: 600;
            transition: background 250ms;
        }
        
        .export-btn {
            margin-top: 10px;
            padding: 12px;
            background: var(--color-green);
            color: white;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: 600;
            transition: background 250ms;
        }
        
        .reset-all-btn:hover {
            background: black;
        }
        
        .export-btn:hover {
            background: #176b2c;
        }
        /* --- */


        @media (max-width: 1200px) {
            #admin-view .content-wrapper {
                flex-direction: column;
            }
            .waves-container {
                grid-template-columns: 1fr;
            }
        }
        @media (max-width: 900px) {
            .colors-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚è±Ô∏è Dual Group Timer Control (SYNCED STOPWATCH)</h1>
            <p>Admin starts the entire wave. Volunteers stop their individual color timers.</p>
        </div>

        <div class="view-toggle">
            <button class="view-btn active" onclick="switchView('admin')" id="admin-toggle">Admin Panel</button>
            <button class="view-btn" onclick="switchView('volunteer')" id="volunteer-toggle">Volunteer Access</button>
        </div>

        <div id="admin-login-view" class="content active">
            <div class="login-section">
                <h2>Admin Login</h2>
                <div class="login-input-group">
                    <input type="password" id="admin-code-input" placeholder="Enter Admin Code" style="flex: 1;">
                    <button onclick="adminLogin()">Login</button>
                </div>
                <div class="login-message" id="admin-login-message">
                    Enter the admin access code to manage the groups. (Code: **ADMIN123**)
                </div>
            </div>
        </div>
        <div id="admin-view" class="content">
            <div class="content-wrapper">
                
                <div class="timer-controls-area">
                    <div class="waves-container">
                        <div class="wave-panel">
                            <div class="wave-header">
                                <div class="wave-title">Group 1 (Odd Waves: 1, 3, 5...)</div>
                                <div class="wave-number-input">
                                    <label for="wave1-number">Wave #:</label>
                                    <input type="number" id="wave1-number" value="1" min="1" onchange="updateWaveNumber(1)">
                                </div>
                            </div>

                            <div class="colors-grid" id="wave1-colors">
                                <div class="access-code-section">
                                    <div class="access-code-label">Volunteer Access Codes for Group 1</div>
                                    <div class="access-code-list" id="wave1-access-codes">
                                        </div>
                                </div>
                            </div>
                            
                            <div class="wave-controls-container">
                                <button class="wave-start-btn" onclick="startWave(1)" id="start-wave-btn-1">START GROUP 1</button>
                                <button class="wave-reset-btn" onclick="resetWave(1)" id="reset-wave-btn-1" disabled>RESET GROUP 1</button>
                                <button class="wave-next-btn" onclick="incrementGroup(1)" id="next-wave-btn-1" disabled>NEXT WAVE</button>
                            </div>
                        </div>

                        <div class="wave-panel">
                            <div class="wave-header">
                                <div class="wave-title">Group 2 (Even Waves: 2, 4, 6...)</div>
                                <div class="wave-number-input">
                                    <label for="wave2-number">Wave #:</label>
                                    <input type="number" id="wave2-number" value="2" min="1" onchange="updateWaveNumber(2)">
                                </div>
                            </div>

                            <div class="colors-grid" id="wave2-colors">
                                <div class="access-code-section">
                                    <div class="access-code-label">Volunteer Access Codes for Group 2</div>
                                    <div class="access-code-list" id="wave2-access-codes">
                                        </div>
                                </div>
                            </div>
                            
                            <div class="wave-controls-container">
                                <button class="wave-start-btn" onclick="startWave(2)" id="start-wave-btn-2">START GROUP 2</button>
                                <button class="wave-reset-btn" onclick="resetWave(2)" id="reset-wave-btn-2" disabled>RESET GROUP 2</button>
                                <button class="wave-next-btn" onclick="incrementGroup(2)" id="next-wave-btn-2" disabled>NEXT WAVE</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="leaderboard-area">
                    <div class="leaderboard-title">üèÜ All-Group Leaderboard (Stopped Times)</div>
                    <div id="global-leaderboard">No times recorded.</div>
                    <button class="reset-all-btn" onclick="resetGlobalLeaderboard()">RESET ALL TIMES</button>
                    <button class="export-btn" onclick="exportLeaderboardToCSV()">EXPORT TO CSV</button>
                </div>
                </div>
        </div>
        <div id="volunteer-view" class="content">
            <div style="text-align: center; margin-bottom: 30px;">
                <h2>Volunteer Access</h2>
                <p style="color: #666; margin-top: 10px;">Enter your access code to view your assigned group and color</p>
            </div>

            <div style="max-width: 400px; margin: 0 auto; margin-bottom: 20px;">
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="access-code-input" placeholder="Enter access code (e.g., 1-RE)" style="flex: 1; padding: 10px; border: 2px solid var(--color-border); border-radius: 4px; font-size: 14px;">
                    <button onclick="volunteerLogin()" style="padding: 10px 20px; background: var(--color-primary); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">Login</button>
                </div>
            </div>

            <div id="volunteer-dashboard-container">
                <div id="volunteer-dashboard" style="display: none;">
                    </div>
            </div>

            <div id="login-message" style="text-align: center; color: #666; margin-top: 20px;">
                Enter an access code to get started
            </div>
        </div>
    </div>

    <script>
        // --- 1. YOUR FIREBASE CONFIGURATION (Using the credentials you provided) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDJkHOV1KVUfCbblgMvlO76u0Ui3J1k1sg",
            authDomain: "arena-stopwatch.firebaseapp.com",
            databaseURL: "https://arena-stopwatch-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "arena-stopwatch",
            storageBucket: "arena-stopwatch.firebasestorage.app",
            messagingSenderId: "194588204548",
            appId: "1:194588204548:web:d77a14dc5ea208e525df51",
            measurementId: "G-P31XYVGJ2Q"
        };
        
        // --- 2. Initialize Firebase and Get Database Reference ---
        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
        } catch (error) {
            console.error('Firebase Initialization Error:', error.message);
        }

        // --- CONSTANTS & LOCAL STATE (Mirrored from Firebase) ---
        const ADMIN_CODE = "ADMIN123"; 
        const RESET_PASSWORD = "Reset"; // Password for group reset
        const GLOBAL_RESET_PASSWORD = "password";
        const BIB_PREFIX = "AW"; 
        
        const COLORS = [
            { name: 'Red', hex: '#c0152f', abbr: 'RE' },
            { name: 'Green', hex: '#228c3d', abbr: 'GR' },
            { name: 'Blue', hex: '#2180ff', abbr: 'BL' },
            { name: 'Yellow', hex: '#e68161', abbr: 'YE' },
            { name: 'Pink', hex: '#ef4899', abbr: 'PI' }
        ];

        let appState = {}; 
        let globalStoppedTimes = [];

        let intervalId;
        const volunteers = {};
        let activeVolunteer = null; 
        let isAdminLoggedIn = false;
        
        // --- UTILITY FUNCTIONS ---
        function generateAccessCode(group, color) {
            const colorData = COLORS.find(c => c.name.toLowerCase() === color.toLowerCase());
            return `${group}-${colorData ? colorData.abbr : color.toUpperCase().slice(0, 2)}`;
        }
        
        function formatBibNumber(num) {
            // Ensure padding is applied to the number part
            return `${BIB_PREFIX}${String(num).padStart(3, '0')}`;
        }

        function formatTime(ms) {
            if (ms < 0) ms = 0;
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            const milliseconds = Math.floor((ms % 1000) / 10);
            
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}:${String(milliseconds).padStart(2, '0')}`;
        }
        
        // --- DATABASE LISTENERS (CRITICAL FOR SYNC) ---
        function startSyncListeners() {
            if (!db) return;

            db.ref('/').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data && data.groups) {
                    appState = data;
                    // Use firebase data structure to build local leaderboard data
                    const leaderboardData = data.leaderboard || {};
                    // Store the Firebase key (for potential deletion if needed)
                    globalStoppedTimes = Object.keys(leaderboardData).map(key => ({...leaderboardData[key], key: key})).filter(Boolean); 
                    
                    updateAllUI();
                    renderLeaderboard();
                } else if (data === null) {
                    // Reinitialize if the entire database is wiped
                    console.log("Database empty. Reinitializing.");
                    initializeDatabase(true); 
                }
            });
        }
        
        // --- SYNCED TIME CALCULATION ---
       function calculateTime(timer) {
    // Calculate time based on the shared startTime from the database
    if (timer.running && timer.startTime) {
        return Date.now() - timer.startTime;
    }
    return timer.elapsed || 0;
}


            // --- TIME FORMATTING (MM:SS:CC) ---
            function formatTime(ms) {
              // Check for the DNF/ERROR value (-1)
             if (ms < 0) {
            return "DNF / ERROR"; 
             }
    
             const totalSeconds = Math.floor(ms / 1000);
             const minutes = Math.floor(totalSeconds / 60);
             const seconds = totalSeconds % 60;
             // Centiseconds (milliseconds / 10, floored)
             const milliseconds = Math.floor((ms % 1000) / 10);
    
             return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}:${String(milliseconds).padStart(2, '0')}`;
}
        function volunteerGiveUp(group, color, buttonElement) {
        const timer = appState.groups[group].timers[color];
    
         if (timer.running) {
        
        if (!confirm(`Are you sure you want to mark ${color} for Group ${group} as DNF/GIVE UP? This action will record an ERROR time.`)) {
            return;
        }

        // FIX: Immediately disable the button to prevent double-clicks
        if (buttonElement) {
            buttonElement.disabled = true;
            buttonElement.textContent = "DNF RECORDED";
        }
        
        // Use a special negative number to denote DNF/GIVE UP
        const DNF_TIME_MS = -1; 
        
        const timerUpdates = {
            running: false,
            elapsed: DNF_TIME_MS, // Set to -1 to signify an error/DNF
            startTime: null 
        };

        const colorInfo = COLORS.find(c => c.name.toLowerCase() === color.toLowerCase());
        const newLeaderboardEntry = { 
            group: parseInt(group), 
            color: colorInfo.name, 
            timeMs: DNF_TIME_MS, // Record the DNF time
            waveNumber: appState.groups[group].number,
            bib: timer.bib || 'N/A',
            recordedTime: firebase.database.ServerValue.TIMESTAMP 
        };
        
        const updates = {};
        updates[`/groups/${group}/timers/${color}`] = {...timer, ...timerUpdates}; 
        
        // PUSH TO LEADERBOARD
        db.ref('/leaderboard').push(newLeaderboardEntry);
        db.ref('/').update(updates);
    }
}
        // --- ADMIN LOGIN LOGIC ---
        function adminLogin() {
            const code = document.getElementById('admin-code-input').value.trim();
            const messageElement = document.getElementById('admin-login-message');
            
            if (code === ADMIN_CODE) {
                isAdminLoggedIn = true;
                messageElement.innerHTML = '<span style="color: var(--color-primary); font-weight: bold;">Login successful!</span>';
                document.getElementById('admin-login-view').classList.remove('active');
                document.getElementById('admin-view').classList.add('active');
                document.getElementById('admin-toggle').classList.add('active');
                updateAllUI();
            } else {
                isAdminLoggedIn = false;
                messageElement.innerHTML = '<span style="color: var(--color-red); font-weight: bold;">Invalid admin code.</span>';
            }
        }
        
        function switchView(view) {
            document.querySelectorAll('.content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.view-btn').forEach(el => el.classList.remove('active'));
            
            if (view === 'admin') {
                if (isAdminLoggedIn) {
                    document.getElementById('admin-view').classList.add('active');
                } else {
                    document.getElementById('admin-login-view').classList.add('active');
                }
            } else { 
                document.getElementById('volunteer-view').classList.add('active');
            }
            
            document.getElementById(`${view}-toggle`).classList.add('active');
        }

        // --- WAVE NUMBER MANAGEMENT & VALIDATION ---
        
        function isWaveNumberUsed(newNumber) {
            return globalStoppedTimes.some(item => item.waveNumber === newNumber);
        }

        function isValidWaveNumber(group, newNumber) {
            if (newNumber < 1) return false;
            // Enforce odd/even rule strictly
            if (group === 1 && newNumber % 2 === 0) return false; 
            if (group === 2 && newNumber % 2 !== 0) return false; 
            return true;
        }

        /**
         * UPDATED: Now also checks if the number has already been recorded on the leaderboard.
         */
        function updateWaveNumber(group) {
            if (!isAdminLoggedIn) return;
            const inputElement = document.getElementById(`wave${group}-number`);
            const newNumber = parseInt(inputElement.value);
            
            if (isValidWaveNumber(group, newNumber)) {
                if (isWaveNumberUsed(newNumber)) {
                    alert(`Wave ${newNumber} has already been recorded on the leaderboard and cannot be repeated. Reverting input.`);
                    // Revert to the value stored in the app state
                    inputElement.value = appState.groups[group].number;
                } else {
                    db.ref(`groups/${group}/number`).set(newNumber);
                }
            } else {
                alert(`Group ${group} wave numbers must be ${group === 1 ? 'odd (1, 3, 5...)' : 'even (2, 4, 6...)'}. Reverting input.`);
                // Revert to the value stored in the app state
                inputElement.value = appState.groups[group].number; 
            }
        }
        
        function updateColorStatus(group, color, newStatus) {
            if (!isAdminLoggedIn) return;
            const timer = appState.groups[group].timers[color];
            
            if (newStatus === 'na' && timer.running) {
                alert("Cannot set status to NA while the timer is running. Please stop or reset the group first.");
                updateAllUI();
                return;
            }
             db.ref(`groups/${group}/timers/${color}/status`).set(newStatus);
        }
        
        function updateBib(group, color) {
            if (!isAdminLoggedIn) return;
            const inputElement = document.getElementById(`bib-w${group}-${color}`);
            const bibPartial = inputElement.value.trim();
            
            if (bibPartial === '' || bibPartial.match(/^\d+$/)) {
                
                let bibValue;
                if (bibPartial === '') {
                    bibValue = ''; // Clears the BIB in the DB
                } else {
                    const num = parseInt(bibPartial, 10);
                    
                    if (isNaN(num)) {
                         alert("Invalid number format. Reverting.");
                         const currentBib = appState.groups[group].timers[color].bib || '';
                         inputElement.value = currentBib.replace(BIB_PREFIX, '');
                         return;
                    }
                    
                    bibValue = formatBibNumber(num);
                }
                
                db.ref(`groups/${group}/timers/${color}/bib`).set(bibValue);
            } else {
                alert("Please enter only numbers for the BIB extension.");
                const currentBib = appState.groups[group].timers[color].bib || '';
                inputElement.value = currentBib.replace(BIB_PREFIX, '');
            }
        }

        
        function incrementGroup(group) {
            if (!isAdminLoggedIn) return;

            const timers = appState.groups[group].timers;
            const currentWaveNumber = appState.groups[group].number;

            const allStopped = Object.values(timers).every(t => !t.running);
            const anyActiveTimeRecorded = Object.values(timers).some(t => t.elapsed > 0 && t.status === 'active');

            if (!allStopped) {
                alert(`Please stop all running timers in Group ${group} before moving to the next wave.`);
                return;
            }
            
            if (anyActiveTimeRecorded) {
                
                // FINAL CHECK: Ensure the current wave number is now considered 'used'
                if (!isWaveNumberUsed(currentWaveNumber)) {
                     // This is an integrity check, indicating a completed wave didn't record a time.
                     // We proceed anyway, but warn the admin if needed, and rely on the next wave logic.
                }

                const newNumber = currentWaveNumber + 2;
                
                const updates = {};
                updates[`groups/${group}/number`] = newNumber;
                
                Object.keys(timers).forEach(color => {
                    updates[`groups/${group}/timers/${color}/running`] = false;
                    updates[`groups/${group}/timers/${color}/elapsed`] = 0;
                    updates[`groups/${group}/timers/${color}/startTime`] = null;
                    updates[`groups/${group}/timers/${color}/status`] = 'active'; 
                    updates[`groups/${group}/timers/${color}/bib`] = ''; 
                });
                
                db.ref('/').update(updates);
            } else {
                 alert(`Cannot move to the next wave (Wave ${appState.groups[group].number + 2}) for Group ${group} because no active times were recorded in the current wave.`);
            }
        }
        
        // --- TIMER CONTROL (SYNC WRITE) ---
        /**
         * UPDATED: Now enforces the odd/even wave number rule AND checks if the number is already used.
         */
        function startWave(group) {
            if (!isAdminLoggedIn) return;
            
            const currentWaveNumber = appState.groups[group].number;

            // 1. Strict Odd/Even Wave Number Check
            if (!isValidWaveNumber(group, currentWaveNumber)) {
                 alert(`Cannot start Group ${group}. The current Wave Number (${currentWaveNumber}) must be ${group === 1 ? 'Odd' : 'Even'}. Please correct it manually.`);
                 return;
            }

            // 2. Strict Wave Number Repetition Check
            if (isWaveNumberUsed(currentWaveNumber)) {
                 alert(`Cannot start Group ${group}. Wave ${currentWaveNumber} has already been completed and recorded on the leaderboard. Please click 'NEXT WAVE' or change the wave number manually.`);
                 return;
            }
            
            const timers = appState.groups[group].timers;
            updateWaveNumber(group); 

            let missingBibs = [];
            let duplicateBibs = []; 
            let updatePayload = {};
            let shouldStart = false;
            
            // Collect all existing BIBs from the leaderboard
            const recordedBibs = new Set(globalStoppedTimes.map(item => item.bib).filter(bib => bib !== 'N/A' && bib !== ''));

            Object.keys(timers).forEach(color => {
                const timer = timers[color];

                if (timer.status === 'active') {
                    if (!timer.bib) {
                         missingBibs.push(color.charAt(0).toUpperCase() + color.slice(1));
                    } else if (recordedBibs.has(timer.bib)) { 
                         duplicateBibs.push(timer.bib);
                    }
                }
                
                if (!timer.running && timer.status === 'active') {
                    updatePayload[`groups/${group}/timers/${color}/running`] = true;
                    shouldStart = true;
                }
            });
            
            if (missingBibs.length > 0) {
                 alert(`Cannot start: Please enter BIB numbers for the following ACTIVE colors: ${missingBibs.join(', ')}.`);
                 return;
            }
            
            if (duplicateBibs.length > 0) {
                 alert(`Cannot start: The following BIB numbers have already completed a wave and are recorded on the leaderboard. Please assign a new BIB or check your inputs: ${duplicateBibs.join(', ')}.`);
                 return;
            }
            
            if (!shouldStart) {
                alert("Cannot start: All active timers are already running or all colors are set to N/A.");
                return;
            }
            
            // Set the master start time field for all timers being started using the ServerValue
            Object.keys(timers).forEach(color => {
                if (updatePayload[`groups/${group}/timers/${color}/running`]) {
                    updatePayload[`groups/${group}/timers/${color}/startTime`] = firebase.database.ServerValue.TIMESTAMP;
                }
            });

            db.ref('/').update(updatePayload);
        }
        
        function resetWaveTimers(group) {
            if (!isAdminLoggedIn) return;

            const updates = {};
            Object.keys(appState.groups[group].timers).forEach(color => {
                updates[`groups/${group}/timers/${color}/running`] = false;
                updates[`groups/${group}/timers/${color}/elapsed`] = 0;
                updates[`groups/${group}/timers/${color}/startTime`] = null;
            });
            db.ref('/').update(updates);
        }
        
        /**
         * Resets the wave timers with a password prompt. 
         * Time is NOT recorded to the leaderboard upon this specific reset.
         */
        function resetWave(group) {
            if (!isAdminLoggedIn) return;
            
            const timers = appState.groups[group].timers;
            const anyTimeRunning = Object.values(timers).some(t => t.running);
            const anyTimeRecorded = Object.values(timers).some(t => t.elapsed > 0);
            
            if (!anyTimeRunning && !anyTimeRecorded) {
                alert(`Group ${group} is already reset and ready to start.`);
                return;
            }

            const password = prompt(`To confirm the force reset of Group ${group} (Wave ${appState.groups[group].number}) and prevent recording times, please enter the password:`);

            if (password === RESET_PASSWORD) {
                // Perform the reset
                resetWaveTimers(group); 
                alert(`Group ${group} Wave ${appState.groups[group].number} timers have been force reset to 00:00:00. No times were recorded to the leaderboard.`);
            } else {
                alert("Reset canceled or incorrect password.");
            }
        }
        
        /**
         * UPDATED: Now takes the button element as an argument to immediately disable it.
         */
        function stopColor(group, color, buttonElement) {
            const timer = appState.groups[group].timers[color];
            
            if (timer.running) {
                
                // FIX: Immediately disable the button to prevent double-clicks/multiple attempts
                if (buttonElement) {
                    buttonElement.disabled = true;
                    buttonElement.textContent = "STOPPED";
                }

                const finalElapsed = calculateTime(timer);
                
                const timerUpdates = {
                    running: false,
                    elapsed: finalElapsed,
                    startTime: null 
                };

                const colorInfo = COLORS.find(c => c.name.toLowerCase() === color.toLowerCase());
                const newLeaderboardEntry = { 
                    group: parseInt(group), 
                    color: colorInfo.name, 
                    timeMs: finalElapsed,
                    waveNumber: appState.groups[group].number,
                    bib: timer.bib || 'N/A',
                    recordedTime: firebase.database.ServerValue.TIMESTAMP 
                };
                
                const updates = {};
                updates[`/groups/${group}/timers/${color}`] = {...timer, ...timerUpdates}; 
                
                // PUSH TO LEADERBOARD
                db.ref('/leaderboard').push(newLeaderboardEntry);
                db.ref('/').update(updates);
            }
        }
        
        function resetGlobalLeaderboard() {
            if (!isAdminLoggedIn) return;
            
            if (confirm("Are you sure you want to completely clear the entire leaderboard and all stopped times across both groups? This action cannot be undone.")) {
                const updates = {};
                updates['/leaderboard'] = null; 
                
                resetWaveTimers(1);
                resetWaveTimers(2);
                
                db.ref('/').update(updates);
            }
        }
        
        function exportLeaderboardToCSV() {
            if (globalStoppedTimes.length === 0) {
                alert("No data to export.");
                return;
            }

            let csv = 'Rank,BIB,Group,Wave,Color,Time (MM:SS:CC)\n';
            
            const sortedTimes = [...globalStoppedTimes].sort((a, b) => a.timeMs - b.timeMs);

            sortedTimes.forEach((item, index) => {
                const rank = index + 1;
                const timeFormatted = formatTime(item.timeMs);
                const bib = item.bib || 'N/A';

                csv += `${rank},${bib},${item.group},${item.waveNumber},${item.color},${timeFormatted}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `Leaderboard_Export_${new Date().toISOString().slice(0, 10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                alert("Your browser does not support downloading files directly. Please copy the data from the screen.");
            }
        }

        // --- UI RENDERING FUNCTIONS (Read from appState) ---
        function updateAllUI() {
            if (!appState.groups) return;
            
            Object.keys(appState.groups).forEach(group => {
                const groupData = appState.groups[group];
                const groupNum = parseInt(group);

                const waveInput = document.getElementById(`wave${groupNum}-number`);
                // Only update the input field if the admin is NOT currently focused on it
                if (waveInput && document.activeElement !== waveInput) {
                    waveInput.value = groupData.number;
                }
                
                Object.keys(groupData.timers).forEach(color => {
                    const timer = groupData.timers[color];
                    const elapsed = calculateTime(timer);
                    const display = formatTime(elapsed);
                    
                    const adminElement = document.getElementById(`timer-w${groupNum}-${color}`);
                    if (adminElement) adminElement.textContent = display;
                    
                    // Update BIB Input field
                    const bibInput = document.getElementById(`bib-w${groupNum}-${color}`);
                    if (bibInput && document.activeElement !== bibInput) {
                        const currentBib = timer.bib || '';
                        // Remove "AW" prefix and any leading zeros for clean display in the input box
                        bibInput.value = currentBib.replace(BIB_PREFIX, '').replace(/^0+/, ''); 
                    }
                    
                    // Update Status Select field
                    const statusSelect = document.getElementById(`status-w${groupNum}-${color}`);
                    if (statusSelect) statusSelect.value = timer.status;
                    
                    const cardElement = document.getElementById(`card-w${groupNum}-${color}`);
                    if (cardElement) {
                        cardElement.classList.toggle('na', timer.status === 'na');
                    }
                    
                    if (activeVolunteer && activeVolunteer.wave == groupNum && activeVolunteer.color == color) {
                        renderVolunteerDashboard(groupNum, color); 
                    }
                });
                
                updateControlButtons(groupNum);
            });
        }
        
        function updateControlButtons(groupNum) {
            const timers = appState.groups[groupNum].timers;
            const resetBtn = document.getElementById(`reset-wave-btn-${groupNum}`);
            const startBtn = document.getElementById(`start-wave-btn-${groupNum}`);
            const nextBtn = document.getElementById(`next-wave-btn-${groupNum}`);

            const allStopped = Object.values(timers).every(t => !t.running);
            const anyTimeRunning = Object.values(timers).some(t => t.running);
            const anyActiveTimeRecorded = Object.values(timers).some(t => t.elapsed > 0 && t.status === 'active');
            const anyTimeRecorded = Object.values(timers).some(t => t.elapsed > 0);
            
            // Start button is enabled only if all timers are stopped
            if (startBtn) startBtn.disabled = !allStopped;
            
            // Reset button is enabled if timers are running OR any time is recorded (allows force reset)
            if (resetBtn) resetBtn.disabled = !anyTimeRunning && !anyTimeRecorded;
            
            // Next Wave button is enabled only if all timers are stopped AND there is any active time recorded
            if (nextBtn) nextBtn.disabled = !allStopped || !anyActiveTimeRecorded;
        }

        function renderLeaderboard() {
            const leaderboardContainer = document.getElementById('global-leaderboard');
            let stoppedTimes = globalStoppedTimes; 

            if (stoppedTimes.length === 0) {
                leaderboardContainer.innerHTML = 'No times recorded.';
                return;
            }

            stoppedTimes.sort((a, b) => a.timeMs - b.timeMs);
            
            let html = `
                <table class="leaderboard-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>BIB</th>
                            <th>Group-Wave #</th>
                            <th>Color</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            stoppedTimes.forEach((item, index) => {
                const colorData = COLORS.find(c => c.name === item.color);
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${item.bib || 'N/A'}</td>
                        <td>${item.group}-${item.waveNumber}</td>
                        <td style="color: ${colorData.hex}; font-weight: bold;">${item.color}</td>
                        <td class="stopped-time">${formatTime(item.timeMs)}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            leaderboardContainer.innerHTML = html;
        }

        /**
         * UPDATED: Passes the button element to the volunteerStop function.
         */
        function renderVolunteerDashboard(group, color) {
            if (!appState.groups || !appState.groups[group]) return;

            const colorInfo = COLORS.find(c => c.name.toLowerCase() === color.toLowerCase());
            const timer = appState.groups[group].timers[color];
            const status = timer.status;
            
            const dashboard = document.getElementById('volunteer-dashboard');

            let timerDisplayContent;
            let timerClass = 'volunteer-timer';
            let currentElapsed = calculateTime(timer);
            let buttonDisabled = !timer.running || status === 'na';
            let buttonText = currentElapsed > 0 && !timer.running ? 'STOPPED' : 'STOP';
            
            if (status === 'na') {
                timerDisplayContent = 'N/A: Not Running This Wave';
                timerClass += ' na-status';
                buttonText = 'STOP'; // Reset text visually for N/A
            } else if (timer.running) {
                timerDisplayContent = formatTime(currentElapsed);
            } else if (currentElapsed > 0) {
                 timerDisplayContent = formatTime(currentElapsed);
                 buttonDisabled = true; 
            } else {
                timerDisplayContent = '00:00:00';
            }
            
            // FIX: Re-render the dashboard to update the time and button state
            dashboard.innerHTML = `
                <div class="volunteer-dashboard">
                    <div class="volunteer-header">
                        <div class="volunteer-wave-number" id="volunteer-group-wave-num">Group ${group} | Wave ${appState.groups[group].number}</div>
                        <h2 style="margin-bottom: 0;">Your Assignment</h2>
                    </div>

                    <div class="volunteer-color-display">
                        <div class="volunteer-color-box" style="background: ${colorInfo.hex};"></div>
                        <div class="volunteer-color-name">${colorInfo.name}</div>
                    </div>

                    <div style="font-size: 14px; color: #666; margin: 10px 0;">Participant BIB: <span style="font-weight: bold; color: var(--color-dark);" id="volunteer-bib">${timer.bib || 'N/A'}</span></div>

                    <div style="font-size: 14px; color: #666; margin: 10px 0;">Track and stop your participant's time</div>

                    <div class="${timerClass}" id="volunteer-timer-${group}-${color}">${timerDisplayContent}</div>

                    <div class="volunteer-controls">
                        <button class="btn-volunteer-stop" id="volunteer-stop-btn" onclick="volunteerStop('${group}', '${color}', this)" ${buttonDisabled ? 'disabled' : ''}>${buttonText}</button>
                        <button class="btn-volunteer-stop" 
                                style="background: var(--color-dark);" 
                                id="volunteer-giveup-btn" 
                                onclick="volunteerGiveUp('${group}', '${color}', this)" 
                                ${buttonDisabled ? 'disabled' : ''} 
                                ${currentElapsed > 0 && !timer.running ? 'disabled' : ''} 
                                >GIVE UP / DNF</button>
                </div>
                `;
        }

        /**
         * UPDATED: Now looks up the button element and passes it to stopColor.
         */
        function volunteerStop(group, color, buttonElement) {
            // Check if the button is currently enabled before calling stopColor
            if (buttonElement && !buttonElement.disabled) {
                 stopColor(group, color, buttonElement);
            }
        }

        // --- INITIALIZATION (Handles First Run/Empty DB) ---
        function initializeDatabase(forceReset = false) {
            const initialGroups = {};
            
            for (let groupNum = 1; groupNum <= 2; groupNum++) {
                const initialTimers = {};
                COLORS.map(c => c.name.toLowerCase()).forEach(color => {
                     initialTimers[color] = { elapsed: 0, running: false, startTime: null, status: 'active', bib: '' };
                });
                
                initialGroups[groupNum] = {
                    number: groupNum === 1 ? 1 : 2,
                    timers: initialTimers
                };
            }
            
            const initialData = {
                groups: initialGroups,
                leaderboard: {} 
            };

            if (forceReset) {
                 db.ref('/').set(initialData);
            } else {
                db.ref('/').once('value').then((snapshot) => {
                    if (!snapshot.exists() || !snapshot.val().groups) {
                        console.log("Database is empty. Initializing state.");
                        db.ref('/').set(initialData);
                    }
                }).catch(error => {
                    console.error("Error reading database on init:", error);
                });
            }
        }
        
        function initializeVolunteers() {
             COLORS.map(c => c.name.toLowerCase()).forEach(color => {
                // Key format: 1-RE
                volunteers[generateAccessCode(1, color)] = { wave: 1, color: color.toLowerCase(), code: generateAccessCode(1, color) };
                volunteers[generateAccessCode(2, color)] = { wave: 2, color: color.toLowerCase(), code: generateAccessCode(2, color) };
            });
        }

        // --- VOLUNTEER LOGIN LOGIC ---
        function volunteerLogin() {
            const inputCode = document.getElementById('access-code-input').value.trim();
            // Convert input to uppercase to match the stored keys (e.g., 1-RE)
            const code = inputCode.toUpperCase(); 
            const messageElement = document.getElementById('login-message');
            const dashboardElement = document.getElementById('volunteer-dashboard');
            
            if (volunteers[code]) {
                activeVolunteer = volunteers[code];
                // Render dashboard using the synchronized appState data
                renderVolunteerDashboard(activeVolunteer.wave, activeVolunteer.color);
                
                messageElement.style.display = 'none';
                dashboardElement.style.display = 'block';
                
            } else {
                activeVolunteer = null;
                messageElement.innerHTML = `<span style="color: var(--color-red); font-weight: bold;">
                    Invalid access code. Please use the format G#-CC (e.g., 1-RE).
                </span>`;
                messageElement.style.display = 'block';
                dashboardElement.style.display = 'none';
            }
        }


        function initializeUI() {
            const colorNames = COLORS.map(c => c.name.toLowerCase());
            
            for (let groupNum = 1; groupNum <= 2; groupNum++) {
                document.getElementById(`wave${groupNum}-number`).value = groupNum === 1 ? 1 : 2;

                colorNames.forEach(color => {
                    const colorData = COLORS.find(c => c.name.toLowerCase() === color);
                    document.getElementById(`wave${groupNum}-colors`).insertAdjacentHTML('beforeend', createColorCardHTML(groupNum, color, colorData));
                    document.getElementById(`wave${groupNum}-access-codes`).insertAdjacentHTML('beforeend', `<span class="access-code">${generateAccessCode(groupNum, color)}</span>`);
                });
            }
            
            initializeVolunteers();
            initializeDatabase(); 
            startSyncListeners(); 
            
            // Set the interval to check for updates only if it's not already running
            if (!intervalId) {
                intervalId = setInterval(updateAllUI, 50); 
            }
        }

        function createColorCardHTML(groupNum, color, colorData) {
            return `
                <div class="color-card" id="card-w${groupNum}-${color}">
                    <div class="color-name">${colorData.name}</div>
                    
                    <div class="bib-input-group">
                        <span>${BIB_PREFIX}</span>
                        <input type="text" 
                               id="bib-w${groupNum}-${color}" 
                               maxlength="3" 
                               placeholder="000" 
                               oninput="this.value = this.value.replace(/[^0-9]/g, ''); updateBib(${groupNum}, '${color}')">
                    </div>

                    <div class="color-indicator" style="background: ${colorData.hex};">
                         <select class="color-status-select" id="status-w${groupNum}-${color}" 
                                onchange="updateColorStatus(${groupNum}, '${color}', this.value)">
                            <option value="active" selected>Active</option>
                            <option value="na">NA</option>
                        </select>
                    </div>
                    <div class="timer-display" id="timer-w${groupNum}-${color}">00:00:00</div>
                </div>
            `;
        }


        document.addEventListener('DOMContentLoaded', initializeUI);
    </script>
</body>
</html>